<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Marcos Irigoyen">
<title>Programação Paralela</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="paralelismo-threads-openmp-sincronizacao" class="book toc2 toc-left text-justify">
<div id="header" style="max-width: 80%;">
<h1>Programação Paralela</h1>
<div class="details">
<span id="author" class="author">Marcos Irigoyen</span><br>
<span id="email" class="email"><a href="mailto:mvbirigoyen@gmail.com">mvbirigoyen@gmail.com</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Sumário</div>
<p><span class="toc-root"><a href="index.html">Programação Paralela</a></span></p><ul class="sectlevel1">
<li><a href="gargalo-de-von-neumann.html">Gargalo de Von Neumann e a Cache</a>
</li>
<li><a href="pipelining-e-vetorizacao.html">Pipelining e Vetorização</a>
</li>
<li><a href="fontes-de-demanda-por-performance-precisao.html">Fontes de demanda por performance: precisão</a>
</li>
<li><a href="multithreading-e-threads-de-hardware.html">Threading por hardware e hyperthreading</a>
</li>
<li><a href="paralelismo-threads-openmp-for.html">Paralelismo por Threads com OpenMP</a>
</li>
<li><a href="paralelismo-threads-openmp-escopos-critical.html">Paralelismo por Threads com OpenMP: Escopo e seções críticas</a>
</li>
<li><a href="paralelismo-threads-openmp-tasks.html">Paralelismo por Threads com OpenMP: Tasks</a>
</li>
<li><a href="extra-openmp-cache-coherency-false-sharing-thread-safety.html">Extra: detalhando coerência de cache, falso compartilhamento e thread-safety</a>
</li>
<li><a href="paralelismo-threads-openmp-sincronizacao.html"><span class="toc-current">Paralelismo por Threads com OpenMP: sincronização com critical e locks</span></a>
<ul class="sectlevel2">
<li><a href="paralelismo-threads-openmp-sincronizacao.html#_introdução_9">Introdução</a>
</li>
<li><a href="paralelismo-threads-openmp-sincronizacao.html#_seções_críticas">Seções críticas</a>
</li>
<li><a href="paralelismo-threads-openmp-sincronizacao.html#_exercício">Exercício</a>
</li>
<li><a href="paralelismo-threads-openmp-sincronizacao.html#_relacionados_9">Relacionados</a>
</li>
<li><a href="paralelismo-threads-openmp-sincronizacao.html#_íntegra_dos_códigos_8">Íntegra dos códigos</a>
</li>
</ul>
</li>
<li><a href="paralelismo-threads-openmp-atomic-reduce.html">Paralelismo por Threads com OpenMP: sincronização com atomic e reduction</a>
</li>
<li><a href="paralelismo-distribuido-mpi-comunicacao-individual.html">Programação distribuída com MPI, Tarefa 14 — Versão de defesa</a>
</li>
<li><a href="paralelismo-distribuido-mpi-comunicacao-bloqueante-instant.html">Programação distribuída com MPI, Tarefa 15 — Versão de defesa</a>
</li>
<li><a href="paralelismo-distribuido-comunicacao-grupo.html">Programação distribuída com MPI, Tarefa 16 — Versão de defesa</a>
</li>
<li><a href="paralelismo-distribuido-comunicacao-grupo-datatype.html">Programação distribuída com MPI, Tarefa 17 — Versão de defesa</a>
</li>
<li><a href="programacao-gpu-openmp.html">Programação em GPU com OpenMP, Tarefa 18 — Versão de defesa</a>
</li>
</ul>
</div>
</div>
<div id="content" style="max-width: 80%;">
<div class="sect1">
<h2 id="paralelismo-threads-openmp-sincronizacao">Paralelismo por Threads com OpenMP: sincronização com critical e locks</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_introdução_9">Introdução</h3>
<div class="paragraph">
<p>O assunto da vez é sincronização, dessa vez, em uma postagem dedicada — porque é bem difícil de se encontrar um problema
paralelo interessante que não precise dela. Certas operações são fundamentalmente seriais, com condições que não podem
ser garantidas enquanto houver possibilidade de modificação de parte alguma do objeto ao qual elas se aplicam
(isso quando o objeto pode ser dividido). É a mesma ideia abordada anteriormente na seção de thread-safety em "Extra: detalhando coerência de cache, falso compartilhamento e thread-safety", mas vale diferenciar duas formas de se alcançar
a thread safety para poder mostrar a importância da sincronização. Para contexto:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>A thread-safety de uma função se refere à capacidade de execução dessa função de forma concorrente/e ou paralela
conforme pretendido. Uma função que possa chegar a um estado de erro por múltiplas execuções simultâneas não pode ser
chamada de thread-safe&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>(&#8230;&#8203;)</p>
</div>
<div class="paragraph">
<p>O princípio para uma função não ser thread-safe é simples: manipulação concorrente de um recurso sem as devidas
precauções para condições de corrida&#8230;&#8203;</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Extra: detalhando coerência de cache<br>
<cite>falso compartilhamento e thread-safety</cite>
</div>
</div>
<div class="paragraph">
<p>A depender da natureza do recurso, temos três opções: atribuir a cada thread seu próprio recurso, como os geradores de
números pseudoaleatórios de "Paralelismo por Threads com OpenMP: Escopo e seções críticas"; subdividir o recurso em
partes acessáveis independentemente (que é basicamente a paralelização que sempre se aborda aqui); ou sincronizar o
acesso ao recurso entre as threads. A segunda opção cai por terra assim que chegamos a um recurso indivisível, enquanto
que a primeira opção depende da capacidade de se usar múltiplos recursos do mesmo tipo para a operação desejada: se
quero adicionar um elemento ao fim de uma lista encadeada, criar outra lista e inserir o elemento nela não soluciona o
problema. Resta então a sincronização como alternativa.</p>
</div>
<div class="paragraph">
<p>Percebendo agora que não expliquei um conceito interessante, imagine uma carga de trabalho com uma unidade arbitrária de
trabalho \(X\), representando o trabalho necessário para se concluir a tarefa. Executando essa carga sobre uma
única máquina capaz de realizar \(T\) unidades de trabalho por segundo, temos um tempo de execução de
\(\frac{X}{T}\). Fazendo uma conta de padaria, poderíamos assumir que \(N\) máquinas capazes de realizar
\(T\) unidades de trabalho executando essa carga em paralelo teriam um tempo de execução de
\(\frac{X}{NT}\). Já tivemos gráficos e tabelas de resultados demais para sabermos que isso não é verdade, então
vamos apontar algumas falhas desse modelo inicial em uma das primeiras ocasiões de listagem que é fora da seção
Relacionados:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A distribuição das cargas entre as máquinas não é instantânea, requerendo trabalho adicional para sua realização.</p>
</li>
<li>
<p>As unidades de carga são discretas, então a maior parte das combinações de \(X\) e \(N\) não
satisfazem a condição \(\frac{X}{N} \in \mathbb{N}\). Por conta disso, desequilíbrios de carga são possíveis
mesmo entre cargas trivialmente paralelizáveis e máquinas com a mesma capacidade.</p>
</li>
<li>
<p>Para cargas mais complexas, existirão partes que simplesmente não podem ser paralelizadas, como as que pretendo tratar
nesta postagem, e relações de dependência entre partes da carga pertencentes a diferentes máquinas. Para cargas que
não podem ser paralelizadas e são independentes da parte paralela, podemos tratá-las como um termo constante; para
demais cargas não paralelizáveis e as relações de dependência entre cargas, é necessário comunicação, e essa comunicação
é um trabalho por si só.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Juntando a considerações como máquinas com diferentes capacidades de realização de trabalho e cargas de tamanho
variável (cuja menor unidade possível não seja igual a de outras cargas), podemos generalizar (arriscando menos erros
de modelagem) para uma soma de contribuições de tempo de execução da forma \(t_{S} + max(t_{P_i}(N) +
t_{C_i}(N)) + t_{B}(N)\), com \(i \in [1, N]\); \(t_{S} \rightarrow\) tempo serial; \(t_{P_i}
\rightarrow\) tempo paralelo da máquina i; \(t_{C_i} \rightarrow\) tempo de comunicação da máquina i; e
\(t_{B} \rightarrow\) tempo de balanceamento de carga. Em geral, a contribuição de \(t_{P_i}\) tende a
diminuir com o aumento de N, enquanto que \(t_{B}\) e \(t_{C_i}\) se mantém ou aumentam. Esta é uma
forma (provavelmente ineficiente) de ver as chamadas fontes de perda de desempenho associadas a programação paralela:
balanceamento de carga e comunicação. (o desbalanceamento de carga está escondido no max, devo falar dele daqui a três
postagens)</p>
</div>
<div class="paragraph">
<p>Como, quando é necessário a sincronização, não temos como saber o progresso das demais threads, a sincronização é feita
através da comunicação. Para isso, convencionalmente usamos da memória compartilhada para transmissão das mensagens: uma
posição da memória é utilizada para envio e recebimento de mensagens através da escrita e leitura da posição.
Imediatamente temos um problema: o acesso e modificação por múltiplas threads em uma mesma posição de memória é uma
receita para problemas. Para garantir que não haja leitura e escrita simultânea, a solução veio por hardware, através de
instruções atômicas. Estas instruções são, por definição, ininterruptíveis e indivisíveis, garantindo que cada instrução
do tipo sobre um determinado recurso seja executado uma de cada vez (alternativamente a isso, você tem a comunicação das
threads em espaços únicos para cada thread, processados serialmente por uma componente). Destas instruções, a instrução
atômica para <em>test-and-set</em>, que atribui um valor a uma posição na memória e retorna seu valor anterior, foi a base para
implementação das <em>locks</em> em computadores multiprocessados 'modernos'. Com a contextualização finalmente terminada,
vamos seguir pro OpenMP.</p>
</div>
</div>
<div class="sect2">
<h3 id="_seções_críticas">Seções críticas</h3>
<div class="paragraph">
<p>A seção <code>critical</code> já foi mencionada previamente em "Paralelismo por Threads com OpenMP: Escopo e seções críticas", mas
agora que temos esse mói de texto da introdução, vou descrever um pouco mais o funcionamento de <code>critical</code>: seções
críticas, para além de permitirem apenas um único acesso ao conteúdo da seção por vez, recebem dois parâmetros
opcionais — um identificador, tal que seções críticas com o mesmo identificador não possam ser acessadas
simultaneamente, e uma dica para o compilador da natureza da sincronização desejada. Dado esse contexto (em especial da
parte final da introdução), como você imaginaria que é implementada uma seção crítica? (gostou da pergunta? 'roubei' do
professor. quebra de parágrafo pra dar suspense)</p>
</div>
<div class="paragraph">
<p>A resposta é simples: por locks. Para cada identificador de seção crítica (incluindo o padrão, quando não é
especificado) é criado uma lock em tempo de compilação e cada entrada e saída de uma seção crítica seria implementada
pela acquisição e soltura da <em>lock</em> respectiva ao identificador da seção. Dessa forma o acesso a cada seção de um
determinado identificador é mutualmente exclusivo entre os demais acessos a seções do mesmo id.</p>
</div>
</div>
<div class="sect2">
<h3 id="_exercício">Exercício</h3>
<div class="paragraph">
<p>OBS.: Na leitura dos requisitos da tarefa relacionada a postagem, acabei me distraindo contextualizando o problema
desnecessariamente e, nisso, passei batido no critério "escreva um programa que cria tarefas&#8230;&#8203;". A paralelização está
sendo feita por <code>for</code> paralelo. Torço que, já que o assunto principal é sincronização, isso não afete muito.</p>
</div>
<div class="paragraph">
<p>Para demonstrar isso, imagine um programa que recebe um valor N, fatore os números de 1 a \(4N\) e organize-os
da seguinte forma: os números múltiplos de 2 são adicionados a uma pilha A, os números múltiplos de 3 são adicionados a
uma pilha B, e os demais números são descartados. No final do programa, os elementos de cada fila são impressos em ordem
decrescente. Pela descrição, a implementação serial é simples (e não é muito diferente de quando fizemos contagem de
primos). Para programas paralelos, entretanto, não podemos ter múltiplas escritas simultâneas nas filas, fazendo-se
necessário um mecanismo de sincronização. Aproveitando que já fomos devidamente apresentados a seções críticas, tem duas
formas diretas de se implementar este programa, uma com seções críticas não-nomeadas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">return_data simple_prime_bins_unnamed(unsigned long num_bins, unsigned long num_threads){

    auto bin_2 = std::priority_queue&lt;unsigned long&gt;();
    auto bin_3 = std::priority_queue&lt;unsigned long&gt;();

    auto start = utils::mark_time();
    #pragma omp parallel for num_threads(num_threads)
    for (auto i = 0; i &lt; num_bins&lt;&lt;2; i++){
        if (i%2 == 0){
            #pragma omp critical
                bin_2.push(i);
        }
        if (i%3 == 0){
            #pragma omp critical
                bin_3.push(i);
        }
    }

    auto end = utils::mark_time();
    unsigned long res = bin_2.size() + bin_3.size();
    if (print_mode==REGULAR) {
        std::priority_queue&lt;unsigned long&gt; bins[2] = {bin_2, bin_3};
        unsigned long bin_nums[2] = {2, 3};
        for (auto i = 0; i &lt; 2; i++){
                printf("%lu bin contents: ", bin_nums[i]);
                while (!bins[i].empty()){
                    printf("%lu ", bins[i].top());
                    bins[i].pop();
                }
                printf("\n\n");
            }
    }
    return {res, utils::calc_time_interval_ms(start, end)};
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Onde, por consequência da exclusividade mútua de acesso de seções com o mesmo identificador mencionada anteriormente, a
inserção em uma fila está desnecessariamente bloqueando a inserção na outra. Uma primeira otimização seria, então, dar
nomes diferentes às seções, da seguinte forma:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">    #pragma omp parallel for num_threads(num_threads)
    for (auto i = 0; i &lt; num_bins&lt;&lt;2; i++){
        if (i%2 == 0){
            #pragma omp critical(bin_2)
                bin_2.push(i);
        }
        if (i%3 == 0){
            #pragma omp critical(bin_3)
                bin_3.push(i);
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para poder ver a diferença, a tabela a seguir resume o resultado de testes para um N (note que <code>num_bins</code> está fazendo
o papel de N nos códigos) de 100000 — grande o suficiente para que se possa distinguir o overhead causado pela
sincronização — e 100 amostras de execuções dos dois modos.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUM_THREADS</p></td>
<td class="tableblock halign-left valign-top" colspan="2"><p class="tableblock">10</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MEAN_TIME_MS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DESV_PAD_TIME_MS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MODE</p></td>
<td class="tableblock halign-left valign-top" colspan="2"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SIMPLE_NAMED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">39.4695</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.8235</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">SIMPLE_UNNAMED</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">58.787</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">1.46218</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Agora, vamos para um programa mais complexo. Se, ao invés de contabilizarmos somente os múltiplos de 2 e de 3,
fornecessemos ao programa um valor P tal que fosse contabilizado os múltiplos dos P-primeiros primos? Para simplificar a
chamada, vamos considerar também que o intervalo de busca dos múltiplos é de 1 a \(4P\) (agora faz sentido o
4N?). Como as seções críticas (e seus identificadores) são definidos em tempo de compilação, não é possível criar uma
seção para cada fila com P sendo definido na execução. Para isso, precisamos deixar o <code>critical</code> do OpenMP de lado e
voltar as locks. Fortuitamente, o OpenMP fornece funcionalidades para isso com o tipo opaco <code>omp_lock_t</code> e as funções
<code>omp_init_lock</code>, <code>omp_set_lock</code>, <code>omp_unset_lock</code> e <code>omp_destroy_lock</code>. O código a seguir demonstra o uso das locks para
o problema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-cpp hljs" data-lang="cpp">return_data dynamic_prime_bins(unsigned long num_bins, unsigned long num_threads){

    auto bins = new std::priority_queue&lt;unsigned long&gt;[num_bins];
    unsigned long* bin_nums = first_n_primes(num_bins, num_threads);
    omp_lock_t* bin_locks = (omp_lock_t*)(std::malloc(num_bins*sizeof(omp_lock_t)));
    for (auto i = 0; i &lt; num_bins; i++){
        omp_init_lock(&amp;bin_locks[i]);
    }

    auto start = utils::mark_time();
    #pragma omp parallel for num_threads(num_threads) schedule(guided)
    for (auto i = 2; i &lt; num_bins&lt;&lt;2; i++){
        for (auto j = 0; (j &lt; num_bins); j++){
            if (i &lt; bin_nums[j]){break;}
            if (i%bin_nums[j] == 0){
                omp_set_lock(&amp;bin_locks[j]);
                bins[j].push(i);
                omp_unset_lock(&amp;bin_locks[j]);
            }
        }
    }

    auto end = utils::mark_time();

    unsigned long res = 0;
    for (auto i = 0; i &lt; num_bins; i++){
        omp_destroy_lock(&amp;bin_locks[i]);
        res += bins[i].size();
        if (print_mode==REGULAR){
            printf("%lu bin contents: ", bin_nums[i]);
            while (!bins[i].empty()){
                printf("%lu ", bins[i].top());
                bins[i].pop();
            }
            printf("\n\n");
        }
    }

    free(bin_locks);
    free((void*) bin_nums);
    delete[] bins;
    return {res, utils::calc_time_interval_ms(start, end)};
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>&lt;aqui caberia um parágrafo e um gráfico do tempo de execução para múltiplos threads e tamanhos de problema, mas estou
ruim de prazos e já estou passando dos requisitos&gt;</p>
</div>
</div>
<div class="sect2">
<h3 id="_relacionados_9">Relacionados</h3>
<div class="ulist">
<ul>
<li>
<p>Para não dizer que não teve nenhum (muito do que teve aqui foi de memória e das aulas), a
<a href="https://www.openmp.org/spec-html/5.0/openmpsu89.html">especificação do critical para OpenMP 5.0</a>. Idealmente você
segue a spec da versão que seu compilador tem suporte, mas a informação daí já é bem útil.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_íntegra_dos_códigos_8">Íntegra dos códigos</h3>
<details>
<summary class="title">main.cpp</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-c++ hljs" data-lang="c++">#include &lt;cstdio&gt;
#include &lt;unordered_map&gt;
#include &lt;string&gt;
#include &lt;cerrno&gt;
#include "utils.h"
#include &lt;dirent.h&gt;
#include &lt;omp.h&gt;
#include &lt;unistd.h&gt;
#include &lt;cstring&gt;
#include &lt;iostream&gt;
#include &lt;type_traits&gt;
#include &lt;queue&gt;
#include &lt;set&gt;

enum PRINT_MODE {
    REGULAR,
    CSV
};

PRINT_MODE print_mode = REGULAR; //had to move it here as i wanted to print pretty trees

std::unordered_map&lt;std::string, PRINT_MODE&gt; print_flags = {
    {"-printCSV", CSV},
};

typedef utils::_return_data&lt;unsigned long&gt; return_data;


typedef return_data (*target_func_ptr)(unsigned long, unsigned long);

return_data simple_prime_bins_unnamed(unsigned long num_bins, unsigned long num_threads){
    
    auto bin_2 = std::priority_queue&lt;unsigned long&gt;();
    auto bin_3 = std::priority_queue&lt;unsigned long&gt;();
    
    auto start = utils::mark_time();
    #pragma omp parallel for num_threads(num_threads)
    for (auto i = 0; i &lt; num_bins&lt;&lt;2; i++){
        if (i%2 == 0){
            #pragma omp critical
                bin_2.push(i);
        }
        if (i%3 == 0){
            #pragma omp critical
                bin_3.push(i);
        }
    }

    auto end = utils::mark_time();
    unsigned long res = bin_2.size() + bin_3.size();
    if (print_mode==REGULAR) {
        std::priority_queue&lt;unsigned long&gt; bins[2] = {bin_2, bin_3};
        unsigned long bin_nums[2] = {2, 3};
        for (auto i = 0; i &lt; 2; i++){   
                printf("%lu bin contents: ", bin_nums[i]);
                while (!bins[i].empty()){
                    printf("%lu ", bins[i].top());
                    bins[i].pop();
                }
                printf("\n\n");
            }
    }
    return {res, utils::calc_time_interval_ms(start, end)};
}

return_data simple_prime_bins_named(unsigned long num_bins, unsigned long num_threads){
    
    auto bin_2 = std::priority_queue&lt;unsigned long&gt;();
    auto bin_3 = std::priority_queue&lt;unsigned long&gt;();
    
    auto start = utils::mark_time();
    #pragma omp parallel for num_threads(num_threads)
    for (auto i = 0; i &lt; num_bins&lt;&lt;2; i++){
        if (i%2 == 0){
            #pragma omp critical(bin_2)
                bin_2.push(i);
        }
        if (i%3 == 0){
            #pragma omp critical(bin_3)
                bin_3.push(i);
        }
    }

    auto end = utils::mark_time();
    unsigned long res = bin_2.size() + bin_3.size();
    if (print_mode==REGULAR) {
        std::priority_queue&lt;unsigned long&gt; bins[2] = {bin_2, bin_3};
        unsigned long bin_nums[2] = {2, 3};
        for (auto i = 0; i &lt; 2; i++){   
                printf("%lu bin contents: ", bin_nums[i]);
                while (!bins[i].empty()){
                    printf("%lu ", bins[i].top());
                    bins[i].pop();
                }
                printf("\n\n");
            }
    }

    return {res, utils::calc_time_interval_ms(start, end)};
}

template &lt;typename T&gt;
unsigned long insert_ordered(T* array, T element, unsigned long arr_size, unsigned long max_size){
    if (arr_size==0){array[0] = element; return 0;}
    unsigned long start = 0;
    unsigned long end = arr_size == 0 ? 0 : arr_size -1; //needed to avoid underflow
    unsigned long middle = (end+start)/2;
    while (start &lt; end){
        if (array[middle] &lt; element){
            start = middle+1;
        } else{
            end = middle;
        }
        middle = (end+start)/2;
    }

    if (array[middle] &lt; element){
        middle++;
    }
    
    if (middle &lt;= end){
        std::memmove(array + middle+1 , array+middle, (arr_size-middle-(max_size&gt;arr_size? 0:1) )*sizeof(T));
        array[middle] = element;
    } else{
        if (max_size&gt;arr_size){
            array[middle] = element;
        }
    }

    return middle;
}

//most of dynamic_prime_bins dev time was on this
unsigned long* first_n_primes(unsigned long n, unsigned int num_threads){
    
    unsigned long* res = static_cast&lt;unsigned long*&gt;(std::malloc(sizeof(unsigned long)*n));
    unsigned long count = 0;
    unsigned long index = 2;
    #pragma omp parallel num_threads(num_threads)
    {
        unsigned long* local_finds = static_cast&lt;unsigned long*&gt;(std::malloc(sizeof(unsigned long)*n));
        while (count &lt; n){
            unsigned long local_count = 0;
            unsigned long bound = n-count;
            
            #pragma omp for
            for (unsigned long i = index; i &lt; index*index; i++){
                bool is_prime = local_count &lt; bound;
                if (is_prime){
                    for (auto j = 0; j &lt; count; j++){
                        if (i%res[j] == 0){
                            is_prime=false;
                            break;
                        }
                    }    
                }
                if (is_prime){
                    local_finds[local_count] = i;
                    local_count++;
                }
            }

            #pragma omp barrier

            for (auto i = 0; i &lt; local_count; i++){
                unsigned long add_index;
                #pragma omp critical
                {
                    add_index = insert_ordered(res, local_finds[i], count, n);
                    if (add_index &lt; n){
                        count = std::min(count+1, n);
                    }
                }
                if (add_index &gt;= n){break;}
            }
            #pragma omp barrier
            #pragma omp single
            {
                index = index*index;
            }
        }
        free(local_finds);
    }
    return res;
}

return_data dynamic_prime_bins(unsigned long num_bins, unsigned long num_threads){
    
    auto bins = new std::priority_queue&lt;unsigned long&gt;[num_bins];
    unsigned long* bin_nums = first_n_primes(num_bins, num_threads);
    omp_lock_t* bin_locks = (omp_lock_t*)(std::malloc(num_bins*sizeof(omp_lock_t)));
    for (auto i = 0; i &lt; num_bins; i++){
        omp_init_lock(&amp;bin_locks[i]);
    }

    auto start = utils::mark_time();
    #pragma omp parallel for num_threads(num_threads) schedule(guided)
    for (auto i = 2; i &lt; num_bins&lt;&lt;2; i++){
        for (auto j = 0; (j &lt; num_bins); j++){
            if (i &lt; bin_nums[j]){break;}
            if (i%bin_nums[j] == 0){
                omp_set_lock(&amp;bin_locks[j]);
                bins[j].push(i);
                omp_unset_lock(&amp;bin_locks[j]);
            }
        }
    }

    auto end = utils::mark_time();
    
    unsigned long res = 0;
    for (auto i = 0; i &lt; num_bins; i++){   
        omp_destroy_lock(&amp;bin_locks[i]);
        res += bins[i].size();
        if (print_mode==REGULAR){
            printf("%lu bin contents: ", bin_nums[i]);
            while (!bins[i].empty()){
                printf("%lu ", bins[i].top());
                bins[i].pop();
            }
            printf("\n\n");
        }
    }

    free(bin_locks);
    free((void*) bin_nums);
    delete[] bins;
    return {res, utils::calc_time_interval_ms(start, end)};
}

std::unordered_map&lt;std::string, target_func_ptr&gt; modes = {
    {"SIMPLE_UNNAMED", simple_prime_bins_unnamed},
    {"SIMPLE_NAMED", simple_prime_bins_named},
    {"DYNAMIC", dynamic_prime_bins},
};

int main(int argc, char* argv[]){
    if (argc &lt; 4){
        printf("Insufficient arguments, use: %s &lt;MODE&gt; &lt;NUM_BINS&gt; &lt;NUM_THREADS&gt; [-printCSV]\n", argv[0]);
        printf("&lt;MODE&gt; being either SIMPLE_UNNAMED, SIMPLE_NAMED, DYNAMIC\n");
        exit(1);
    } else{
        if (argc &gt; 5) {
            printf("Too many arguments starting at %s. Use: %s &lt;MODE&gt; &lt;DIR_PATH&gt; &lt;NUM_THREADS&gt; [-printCSV]\n",
                argv[5], argv[0]);
            exit(1);
        }
        if (argc == 5){
            auto temp_print = print_flags.find(argv[4]);
            if (temp_print == print_flags.end()){
                printf("Invalid argument: %s. Usage: %s &lt;MODE&gt; &lt;DIR_PATH&gt; &lt;NUM_THREADS&gt; [-printCSV]\n",
                    argv[4], argv[0]);
                exit(1);
            }
            print_mode = temp_print-&gt;second;
        }
    }

    auto mode = modes.find(argv[1]);
    if (mode == modes.end()){
        printf("Invalid mode: %s. Choose between SERIAL, TASK_PARALLEL or TASK_PARALLEL_OPTIMIZED\n", argv[1]);
        exit(1);
    }

    target_func_ptr func = mode-&gt;second;

    
    size_t params[2];
    for (auto i = 0; i &lt; 2; i++){
        params[i] = std::strtoul(argv[2+i], NULL, 10);
        if (params[i] == 0 || errno == ERANGE){
            printf("Invalid parameter: %s.\n", argv[2+i]);
            exit(1);
        }
    }

    return_data exec_data = mode-&gt;second(params[0], params[1]);

    switch (print_mode){
    case CSV:
        printf("%s, %lu, %lu, %lu, %f\n", argv[1], params[0], params[1], exec_data.res, exec_data.time_ms);
        break;
    default:
        printf("Result for n = %lu: %lu; Total elapsed time: %f ms\n", params[0], exec_data.res, exec_data.time_ms);
        break;
    }

    return 0;
}</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">run_tests.sh</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">EXEC_FILE="./a.out"
PYTHON_EXEC=python3

START_THREADS=10
MAX_THREADS=10
THREAD_VALUES=`seq $START_THREADS $MAX_THREADS` #ive got lazy to rewrite back the while loop
MODES="SIMPLE_NAMED SIMPLE_UNNAMED"
PROBLEM_SIZE=100000
NUM_SAMPLES=100

OUTPUT_FILE=$1
STATUS=0

if [ -z "$OUTPUT_FILE" ]
then
    echo "Pass the path to an output file, use: $0 &lt;path/to/output&gt;"
    exit
fi

echo MODE,NUM_BINS,NUM_THREADS,BINS_TOTAL_SIZE,TIME_MS &gt; $OUTPUT_FILE


for MODE in $MODES
do
    SAMPLE=1
    while [ "$SAMPLE" -le "$NUM_SAMPLES" ]
    do
        for NUM_THREADS in $THREAD_VALUES
        do
            echo running "$EXEC_FILE $MODE $PROBLEM_SIZE $NUM_THREADS -printCSV &gt;&gt; $OUTPUT_FILE"
            $EXEC_FILE $MODE $PROBLEM_SIZE $NUM_THREADS -printCSV &gt;&gt; $OUTPUT_FILE
            STATUS=$?
            if [ "$STATUS" -ne 0 ]
            then
                echo Some error occurred, stopping early.
                exit
            fi
        done
        SAMPLE=$(($SAMPLE+1))
    done
done</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">process_data.py</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-python hljs" data-lang="python">import pandas as pd
import sys

if len(sys.argv) &lt; 3: print(f"Too few arguments, use {sys.argv[0]} &lt;input_filepath&gt; &lt;output_path&gt;"); exit(0)
if len(sys.argv) &gt; 3: print(f"Too many arguments, use {sys.argv[0]} &lt;input_filepath&gt; &lt;output_path&gt;"); exit(0)

data = pd.read_csv(sys.argv[1])

data = data.groupby(['MODE', 'NUM_THREADS']).aggregate(
    MEAN_TIME_MS=('TIME_MS', 'mean'),
    DESV_PAD_TIME_MS=('TIME_MS', 'std')
).unstack('NUM_THREADS')

data.columns = data.columns.swaplevel(0,1)
data = data.sort_index(axis=1)#.reset_index(level='')

data.to_csv(sys.argv[2], float_format="%.6g")

#can't differentiate indexes to merge, maybe adding a index list of which lines to merge?
def csv_line_to_asciidoc(_line, sep=",", merge=True):
    line = _line
    if _line.endswith("\n"): line = _line[:-1]
    skip_tuple_token = (None, None)
    new_line = []
    ipair_line = list(enumerate(line.split(sep)))
    for i, word in ipair_line:
        if i is None:
            continue
        rep_count = 0
        if merge or word == '':
            for j, next_word in ipair_line[i+1:]:
                if next_word != word:
                    if next_word != '':
                        break
                rep_count += 1
                ipair_line[j] = skip_tuple_token
        if rep_count == 0:
            new_line.append(f"|{word}\n")
        else:
            new_line.append(f"{rep_count+1}+|{word}\n")
    new_line[-1] = new_line[-1][:-1] + "  \n" 
    return "".join(new_line)
        
merge_indexes = [0]
for i,line in enumerate(open(f"{sys.argv[2]}").readlines()):
    print(csv_line_to_asciidoc(line, merge=i in merge_indexes))</code></pre>
</div>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>← Previous: <a href="extra-openmp-cache-coherency-false-sharing-thread-safety.html">Extra: detalhando coerência de cache, falso compartilhamento e thread-safety</a> | ↑ Up: <a href="index.html">Programação Paralela</a> | Next: <a href="paralelismo-threads-openmp-atomic-reduce.html">Paralelismo por Threads com OpenMP: sincronização com atomic e reduction</a> →</p>
</div>
</div>
<div id="footer" style="max-width: 80%;">
<div id="footer-text">
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
})
MathJax.Hub.Register.StartupHook("AsciiMath Jax Ready", function () {
  MathJax.InputJax.AsciiMath.postfilterHooks.Add(function (data, node) {
    if ((node = data.script.parentNode) && (node = node.parentNode) && node.classList.contains("stemblock")) {
      data.math.root.display = "block"
    }
    return data
  })
})
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>